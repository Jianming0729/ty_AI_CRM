# Phase 0: OpenClaw 部署与基础环境安装手册

本手册专门为 macOS (Apple Silicon) 用户设计，用于指导《桐叶租车智能客服系统》底层引擎 OpenClaw 的搭建。

## ⚠️ 安全警示
1. **官方仓库地址**：[https://github.com/openclaw/openclaw](https://github.com/openclaw/openclaw)
2. **禁止风险行为**：近期发现“假 Moltbot/Clawbot 扩展”投毒案例。**严禁安装任何 VSCode 市场中的 OpenClaw/Moltbot/Clawbot 扩展**。
3. **拉取原则**：务必仅从官方 GitHub 地址通过 `git clone` 或官方 `npm` 包安装。

---

## 1. 安装方式（二选一）

### 途径 A：Node.js CLI 方式（推荐）
适合开发调试。要求 Node.js >= 22。

1. **安装 CLI**：
   ```bash
   npm install -g openclaw@latest
   ```
2. **初始化部署 (Onboarding)**：
   ```bash
   openclaw onboard --install-daemon
   ```
   *注意：将配置文件保存至项目本地的 `gateway/config/openclaw.json`，以便统一管理。*

### 途径 B：Docker Compose 方式
适合隔离运行。要求已安装 Docker Desktop。

1. **拉取镜像**：
   ```bash
   docker pull openclaw/openclaw:latest
   ```
2. **配置示例**：
   在 `gateway/` 目录下创建 `docker-compose.yml`：
   ```yaml
   services:
     openclaw-gateway:
       image: openclaw/openclaw:latest
       ports:
         - "18789:18789"
       volumes:
         - ./config/openclaw.json:/config/openclaw.json:ro
         - ./logs:/logs
       environment:
         - CLAWDBOT_GATEWAY_TOKEN=${GATEWAY_TOKEN}
   ```
3. **启动**：
   ```bash
   export GATEWAY_TOKEN=$(openssl rand -hex 32)
   docker-compose up -d
   ```

---

## 2. 统一目录与配置规范

### 日志目录
- **路径**：`ty_AI_CRM/gateway/logs/`
- **规范**：Gateway 运行日志应完整循环记录启动时间、端口分配及配置加载状态。

### 配置文件 `openclaw.json`
- **项目路径建议**：使用项目本地路径 `gateway/config/openclaw.json`。
- **差异说明**：
  - **用户全局 (`~/.openclaw/`)**：方便全局调用命令，但不利于多项目隔离与 Git 版本控制。
  - **项目本地 (`./gateway/config/`)**：【推荐】配置随项目走，利于团队协作，敏感信息（token）通过环境变量注入。

### 配置示例
```json
{
  "gateway": {
    "port": 18789,
    "address": "127.0.0.1",
    "token": "$CLAWDBOT_GATEWAY_TOKEN"
  },
  "debug": true
}
```

---

## 3. 验收标准与故障排查

### 端口检查
如果 18789 端口被占用，请执行：
```bash
lsof -i :18789
```
若需更改端口，请修改 `openclaw.json` 并重启。

### 连通性冒烟测试
执行以下命令：
```bash
openclaw agent --message "hello" --thinking high
```
- **成功标志**：终端输出 Agent 回复的内容。
- **失败排查**：
  1. 检查 Gateway 进程是否在运行。
  2. 检查 `local-llm/mock_provider.py` 是否已启动（如果使用了本地 Mock）。
  3. 查看 `gateway/logs/` 下的实时日志。

---
*Generated by Antigravity for Tongye AI CRM | 2026-02-01*
