# 《桐叶租车智能客服系统（OpenClaw 版）全景方案》

## 1. 项目目标与范围
本系统旨在通过 AI Agent 技术（基于 OpenClaw 框架）提升桐叶租车的客户服务效率与销售转化率。

- **客服答疑**：基于 RAG（检索增强生成）技术，自动识别并回答租车政策、流程、保险条款等高频问题。
- **销售/保险主动营销**：在对话中识别营销时机，主动推荐高收益保险套餐、车型升级或加购服务。
- **转人工服务**：针对事故、投诉、复杂赔付等高风险场景，实现平滑的人工坐席介入。
- **审计与合规**：记录所有 AI 对话行为、引用的知识片段及调用的工具 API，确保服务过程可追溯、可审计。

## 2. 系统能力边界
为确保系统鲁棒性，明确采用“分级响应”策略：

| 领域 | 处理方式 | 核心逻辑 |
| :-- | :-- | :-- |
| **政策/条款/FAQ** | **RAG Service** | 检索《租车政策汇编》，通过语义匹配与重排给出准确回答。 |
| **实时业务数据** | **Rental Tools (API)** | 价格、库存、订单状态、押金退还进度，严禁 LLM 脑补，必须调用业务系统 API。 |
| **高风险/决策** | **Human Handoff** | 事故报备、理赔承诺、投诉纠纷、超范围索赔等，由系统自动识别意图并引导至人工。 |

## 3. 总体架构说明
系统采用 OpenClaw 作为核心调度内核，通过 Skill/Tool 机制连接业务系统与本地模型。

- **OpenClaw Gateway**：Agent 执行引擎，负责消息编排、技能分发与状态管理。
- **WeCom Bridge**：连接企业微信生态的中间件，负责加解密、会话映射与卡片消息渲染。
- **RAG Service**：基于向量数据库（如 Qdrant/pgvector）提供知识检索与条款引用。
- **Rental Tools**：对桐叶租车现有业务 API 的 Agent 安全封装，包含库存、报价、订单、门店等工具。
- **Local Model Provider**：本地模型后端（如 Ollama 或原生推理），主打 Llama 3 (8B) 或 DeepSeek-R1 等轻量级模型以兼顾成本。
- **Observability/Eval**：全链路日志审计与评价集回归系统。

## 4. 最小闭环数据流
`WeCom (用户发言) -> Bridge (验签/解密) -> OpenClaw Gateway (意图识别) -> RAG/Tools (数据召回) -> Agent (生成回答) -> Bridge (渲染卡片/文本) -> WeCom (回复用户)`

## 5. 架构图 (ASCII)

```text
       [WeCom 用户]
            |
            v
   [WeCom Bridge 服务] --(WS/HTTP)--> [OpenClaw Gateway]
            |                            |
            |           +----------------+----------------+
            |           |                                 |
            |           v                                 v
            |     [RAG Service]                   [Rental Tools]
            |    (向量库/重排/引用)             (库存/报价/订单/门店)
            |           |                                 |
            +-----------+<--------------------------------+
            |
            v
   [WeCom 回复消息（文本/卡片/菜单）]
```

## 6. 子系统拆分与职责边界

### 6.1 WeCom Bridge
- **输入**：企业微信消息回调。
- **输出**：标准化的 OpenClaw 消息协议数据。
- **职责**：身份验证、多模态消息（语音转文字）、卡片模板渲染。
- **失败兜底**：若 OpenClaw 无响应，返回“抱歉，客服系统正在维护，请拨打门店热线”。

### 6.2 OpenClaw Gateway (Orchestrator)
- **输入**：用户文本及上下文。
- **输出**：结构化动作（Skill Call）或生成的文本。
- **职责**：意图路由（KB类/Tool类/Handoff类）、长短期记忆管理。
- **失败兜底**：LLM 幻觉检测，若无法确定则执行“转人工”。

### 6.3 RAG Service
- **输入**：用户查询 Query。
- **输出**：Top-N 相关知识片段及置信度评分。
- **职责**：混合检索（Vector + BM25）、条款重排。
- **失败兜底**：未搜到相关知识时，返回“未在政策中找到答案”，触发兜底回复。

### 6.4 Rental Tools (API Bridge)
- **输入**：结构化参数（如 `city='北京'`, `time='2026-02-02'`）。
- **输出**：业务系统的真实 JSON。
- **职责**：API 参数校验、异常映射、敏感字段脱敏。
- **失败兜底**：API 超时返回“实时库存查询失败”，引导用户咨询人工。

## 7. Phase 0 / Phase 1 交付物清单
| 阶段 | 交付物 | 验收标准 | 回滚策略 |
| :-- | :-- | :-- | :-- |
| **Phase 0** | 后台工程骨架 & OpenClaw Gateway 部署 | `openclaw doctor` 检查通过；WeCom Bridge 通讯畅通。 | 删除容器/停止服务，不影响原业务系统。 |
| **Phase 1** | RAG 基础知识库 (50+ Chunks) & 5 个核心 Tool | 100 条评测集正确率 ≥ 80%；工具能返回真实库存报价。 | 知识库热更新失败可回滚至上个版本 JSON。 |

## 8. 风险清单
- **工程风险**：OpenClaw 作为新兴开源项目，API 稳定性可能存在波动。
- **依赖风险**：本地推理显存消耗超支（24GB 限制），可能在高并发时导致响应速度下降。
- **数据一致性**：业务 API 返回数据版本与知识库政策版本不一致，需建立同步更新机制。

---

### “Phase 0/1：原子级任务列表（每一步可验证）”

1. **[验证] OpenClaw 基础环境安装**：
   - 执行 `npm install -g openclaw@latest` 并通过 `--help` 验证。
   - 运行 `openclaw onboard` 完成 Gateway 基础配置。
2. **[验证] 知识库 Chunking 测试**：
   - 编写 `docs/kb/insurance_rules.md`，执行切分脚本，验证 Chunk ID 与标题锚点生成。
3. **[验证] 最小 API 联通**：
   - 在 Flask 业务系统增加 `/agent/inventory` 接口，通过 OpenClaw Skill 触发调用并打印输出。
4. **[验证] 企业微信消息闭环**：
   - 手机发送“测试”，WeCom Bridge 后台日志显示成功接收并转发至 Gateway，本地 Agent 成功回复文本。

### “日志/审计规范（字段级）”

系统需在 `logs/audit.jsonl` 中持久化以下字段：
- `session_id`: 唯一会话 ID
- `user_query`: 用户原始输入
- `intent_tag`: 意图分类（FAQ/Tool/Handoff）
- `retrieved_chunks`: 检索到的知识片段 ID 及内容引用
- `tool_calls`: 调用了哪些业务 API 及其入参
- `llm_raw_response`: 模型生成的原始文本
- `final_msg`: 最终发送给用户的卡片或消息内容
- `timestamp`: 毫秒级时间戳

### “评价集回归测试计划（先占位，Phase 2 完成）”

1. **基准集**：采用《桐叶租车 100 条中文测试问法》。
2. **评测维度**：正确率（Acceptance Rate）、召回准确度（Recall Accuracy）、幻觉率（Hallucination Rate）。
3. **回归方式**：每次 RAG 算法调整或模型参数修改后，自动重放 100 条问法并与标准答案（Gold Standard）比对。
4. **自动化打分**：使用 GPT-4o 作为裁判模型执行 ELO 评分或二元正确性判定。

---
*注：本方案严格遵循 openclaw/openclaw 官方架构设计，输出语言：中文。*
