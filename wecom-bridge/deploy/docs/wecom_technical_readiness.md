# 微信客服 API 接入技术就绪说明 (SaaS 第三方应用版)

## 1. 接入模式说明
本系统（WeCom Bridge）采用 **企业微信第三方应用 (Third-party App)** 模式进行开发与接入。
- **服务商身份**：作为独立服务商，通过企微三方协议为各授权租户提供 AI 自动回复、人工对账及身份分发服务。
- **架构解耦**：系统逻辑层完全不依赖单一企业的 `CorpSecret`，实现了业务逻辑与租户实例的彻底解耦，具备服务海量企业客户的技术能力。

## 2. 多租户授权与令牌治理架构

系统采用 **“三级认证、双层持久化”** 的多租户治理架构，确保数据物理隔离与令牌安全。

### 2.1 架构示意图
```text
[企微推送] --(回调事件)--> [Bridge 网关] --(Suite Ticket)--> [PostgreSQL (SSOT)]
                                 |                          ^
                                 |                          |
                         [Token Factory 引擎] <-------(提取 Permanent Code)
                                 |
                         [SQLite 令牌缓存]
                                 |
                         [执行 API 调用 (微信客服接口)]
```

### 2.2 多租户隔离机制
- **身份隔离**：系统强制要求所有 API 调用显式传入 `corp_id`。
- **确权隔离**：每个租户的 `permanent_code` 与产生的 `access_token` 均作为数据库索引主键，在存储与访问层面杜绝跨租户越权。

## 3. 核心凭证生命周期管理

针对三方应用协议中的关键凭据，系统实现了分类治理：

| 凭证类型 | 存储位置 | 生命周期策略 | 作用说明 |
| :--- | :--- | :--- | :--- |
| **Suite Ticket** | PostgreSQL | 每 10-20 分钟原子更新。 | 作为系统生存的“第一根地线”，确保重启后能立即换票。 |
| **Permanent Code** | PostgreSQL | **永久固化**。在企业授权时获取并快照存储。 | 租户授权的数字契约，是置换企业令牌的合法依据。 |
| **Corp Token** | SQLite | 2 小时有效。由 Token Factory 自动刷新。 | 实际调用微信客服 API 的受控凭证。 |

## 4. 高可用与重启安全性声明

- **状态恢复能力**：所有决定生存能力的核心票据（Ticket/Permanent Code）均已持久化至 PostgreSQL。系统在意外重启或扩容后，能秒级加载最新状态并自动“预热” Token 缓存，无需人工干预或重新授权。
- **令牌刷新幂等**：`Token Factory` 在执行令牌置换时具备互斥逻辑，防止在令牌过期瞬间产生大规模并发换码请求，确保符合微信接口频控要求。
- **消息幂等去重**：集成消息 ID 去重模块，有效拦截企微回调的重复推送，保证客服回复的唯一性与准确性。

---
**提交单位**：WeCom Bridge 架构工程组  
**日期**：2026年02月08日
