# æ¡å¶ç§Ÿè½¦æ™ºèƒ½å®¢æœç³»ç»Ÿï¼šå…¨å±€å‘½åä¸èº«ä»½æ²»ç†æ ‡å‡† (v2.0)

æœ¬é¡¹ç›®å®šä¹‰äº†å…¨æ¸ é“ï¼ˆä¼ä¸šå¾®ä¿¡ã€WeChatã€Appã€ç”µè¯ï¼‰ç»Ÿä¸€çš„ç”¨æˆ·èº«ä»½è¯†åˆ«ä¸å·¥ç¨‹æ²»ç†ä½“ç³»ã€‚æœ¬è§„èŒƒä¸ºå…¨å±€æœ€é«˜æƒå¨ï¼Œæ‰€æœ‰æ¨¡å—å¿…é¡»å¼ºåˆ¶æ‰§è¡Œã€‚

---

## ä¸€ã€æ ¸å¿ƒè®¾è®¡åŸåˆ™ (Engineering Principles)

1.  **å•ä¸€äº‹å®æº (SSOT)**: 
    - ç‰©ç†äººåœ¨ç³»ç»Ÿä¸­çš„å”¯ä¸€èº«ä»½æ ‡è¯†ç¬¦ä¸º `ty_uid`ã€‚
    - `ty_uid` ç»ˆèº«ä¸å˜ã€è·¨ç³»ç»Ÿã€è·¨æ¸ é“ã€è·¨æ—¶é—´ã€‚
2.  **Chatwoot éä¸­æ¢åŸåˆ™**:
    - Chatwoot ä»…ä½œä¸º CRM å¯¹è¯å·¥ä½œå°ã€‚ä¸šåŠ¡èº«ä»½ä¸»æƒå½’å±äº Tongye èº«ä»½æœåŠ¡ã€‚
    - ä¸¥ç¦ä½¿ç”¨ Chatwoot çš„ `Contact ID` æˆ– `User ID` ä½œä¸ºä¸šåŠ¡å±‚å…³è”é”®ã€‚
3.  **èº«ä»½æœ¯è¯­æ¶ˆæ­§ (Forbidden Terms)**:
    - **ä¸¥ç¦**ä½¿ç”¨è£¸çš„ `user` / `user_id` å­—æ®µã€‚
    - å¿…é¡»æ˜¾å¼æŒ‡æ˜â€œåœ¨å“ªä¸ªåŸŸã€æ‰®æ¼”ä»€ä¹ˆèº«ä»½è§’è‰²â€ã€‚

---

## äºŒã€èº«ä»½ä¸‰å±‚æ¨¡å‹ (Identity Model)

### Layer 1: æœºå™¨å”¯ä¸€èº«ä»½ (Machine Identity)
- **å­—æ®µå**: `ty_uid`
- **æ ¼å¼**: `TYU_` + ULID (ä¾‹å¦‚: `TYU_01KGJNCQ6FN4J26KGGHANWQ1T0`)
- **è¯´æ˜**: ç³»ç»Ÿå…¨å±€ä¸»é”®ï¼ŒSSOTï¼Œæ°¸ä¸ç›´æ¥å±•ç¤ºç»™äººç±»ç”¨æˆ·ã€‚

### Layer 2: ä¸šåŠ¡è§’è‰²ç±»å‹ (Actor Type)
ä¸€ä¸ªäººåªæœ‰ä¸€ä¸ª `ty_uid`ï¼Œä½†åœ¨ä¸åŒåœºæ™¯ä¸‹æ‰®æ¼”ä¸åŒ `actor_type`ï¼š
- **`agent`**: Chatwoot åå¸­/ç®¡ç†å‘˜ï¼ˆä»…é™æœ‰å¸­ä½çš„äººï¼‰ã€‚
- **`customer`**: å¤–éƒ¨ç§Ÿè½¦å®¢æˆ·ï¼ˆé»˜è®¤ç±»å‹ï¼‰ã€‚
- **`employee`**: å†…éƒ¨å‘˜å·¥ï¼ˆéåå¸­èº«ä»½ï¼Œå¦‚å¤–å‹¤äººå‘˜ï¼‰ã€‚
- **`partner`**: ä¾›åº”å•†/åˆä½œæ–¹ã€‚

### Layer 3: äººç±»å¯è¯»æ˜¾ç¤ºä»£å· (Handle/Display ID)
ç”¨äº UI å±•ç¤ºã€è¿è¥æ£€ç´¢ä¸å¿«é€Ÿè¾¨è¯†ã€‚
- **æ ¼å¼**: `{PREFIX}-{SEQUENCE}` (ä¾‹å¦‚: `A-000001`, `U-000456`)
- **å‰ç¼€è§„èŒƒ**:
    - `A-`: Agent (åå¸­)
    - `U-`: User/Customer (å¤–éƒ¨å®¢æˆ·)
    - `E-`: Employee (å†…éƒ¨å‘˜å·¥)
    - `P-`: Partner (ä¾›åº”å•†)
- **å®½åº¦**: å»ºè®® 6 ä½æ•°å­—ï¼Œæ”¯æŒ 10W+ å¹¶å¯å¹³æ»‘æ‰©å±•ã€‚

---

## ä¸‰ã€æ•°æ®åº“æ¶æ„è§„èŒƒ (Database Schema)

### 3.1 æ ¸å¿ƒä¸»è¡¨ (Postgres)
èº«ä»½æœåŠ¡å¿…é¡»ç‹¬ç«‹äºä¸šåŠ¡åº“è¿è¡Œï¼Œæ•°æ®åº“åä¸º `ty_identity`ã€‚

#### A. `users` (ç”¨æˆ·ä¸»è¡¨)
- `ty_uid` (PK, varchar): å…¨å±€ä¸»é”®ã€‚
- `actor_type` (varchar): è§ Layer 2 å®šä¹‰ã€‚
- `handle` (varchar): è§ Layer 3 å®šä¹‰ï¼Œå…¨å±€å”¯ä¸€ã€‚
- `status` (varchar): `active` / `blocked` / `merged`ã€‚

#### B. `identities` (å¤–éƒ¨èº«ä»½æ˜ å°„è¡¨)
- `ty_uid` (FK)
- `provider` (varchar): `wecom`, `wechat`, `phone`, `email`, `chatwoot` ç­‰ã€‚
- `external_key` (varchar): å¦‚ `external_userid`, `unionid`, `phone_number`ã€‚
- `is_verified` (boolean): æ˜¯å¦é€šè¿‡å¼ºæ ¡éªŒï¼ˆå¦‚ OTP æˆ– OAuthï¼‰ã€‚
- **å”¯ä¸€çº¦æŸ**: `UNIQUE(provider, external_key)`ã€‚

#### C. `chatwoot_links` (CRM å…³è”è¡¨)
- `ty_uid` (FK)
- `chatwoot_account_id`
- `chatwoot_inbox_id`
- `chatwoot_contact_id`
- `last_conversation_id`

---

## å››ã€Chatwoot è§†è§’çš„ä¸¥æ ¼å®šä¹‰

1.  **Chatwoot User (åå¸­)**:
    - å¿…é¡»å…·å¤‡ `actor_type = agent`ã€‚
    - æ˜¾ç¤ºåå¼ºåˆ¶æ”¹ä¸º: `A-000123 | Real Name`ã€‚
2.  **Chatwoot Contact (è”ç³»äºº)**:
    - ä»…ä»…æ˜¯â€œå¯¹è¯å¯¹è±¡çš„å®¹å™¨â€ã€‚
    - **Source ID (å¼ºåˆ¶)**: `ty:TYU_...` (ä¸¥ç¦ä½¿ç”¨ `wecom:xxx`)ã€‚
    - **æ˜¾ç¤ºåå¼ºåˆ¶æ ¼å¼**: `U-000456 | æ˜µç§°`ã€‚
    - **è‡ªå®šä¹‰å±æ€§ (Custom Attributes)**: å¿…é¡»åŒ…å« `ty_uid`, `handle`, `actor_type`ã€‚

---

## äº”ã€è¿è¡Œæ—¶æ²»ç†æµç¨‹ (Runtime Flows)

### 5.1 å…¥ç«™è¯†åˆ«æµç¨‹
1. **Bridge æ¥æ”¶**: æå–å¤–éƒ¨ IDï¼ˆå¦‚ WeCom `external_userid`ï¼‰ã€‚
2. **èº«ä»½è§£æ**: è°ƒç”¨ `resolve_or_create(provider, key)`ã€‚
3. **SSOT çº§ç©¿é€**:
   - è‹¥ä¸å­˜åœ¨ï¼Œç”Ÿæˆæ–° `ty_uid`ï¼Œåˆ†é… `handle` (U-xxx)ã€‚
   - è‹¥å·²å­˜åœ¨ï¼Œè¿”å›ç°æœ‰ `ty_uid` ä¿¡æ¯ã€‚
4. **åŒæ­¥è‡³ Chatwoot**:
   - æ£€æŸ¥ `chatwoot_links`ã€‚
   - å†™å…¥ Contactï¼Œè®¾ç½®æ˜¾ç¤ºå `U-xxx | æ˜µç§°` åŠ `source_id = ty:TYU_...`ã€‚

### 5.2 å®¡è®¡ä¸äº‹ä»¶ (user_events)
æ‰€æœ‰ä¸šåŠ¡é‡è¦åŠ¨ä½œå¿…é¡»è®°å½•åœ¨ `user_events` è¡¨ï¼š
- `event_type`: `message_in`, `message_out`, `intent_classified`, `human_transfer` ç­‰ã€‚
- `payload`: å­˜å‚¨åŸå§‹ä¿¡æ¯æ¦‚è¦ã€‚

---

## å…­ã€èº«ä»½å‡çº§ä¸åˆå¹¶è§„åˆ™ (Upgrade & Merge)

### 6.1 èº«ä»½å‡çº§
- å¤–éƒ¨èº«ä»½æ ¹æ®éªŒè¯çº§åˆ«ï¼ˆVerifiedï¼‰ç¡®å®šæƒé‡ï¼š
  - **å¼±é”šç‚¹**: ä¼å¾®ä¸´æ—¶å¤–éƒ¨ IDã€ç½‘é¡µåŒ¿å IDã€‚
  - **å¼ºé”šç‚¹**: æ‰‹æœºå· (OTP)ã€å¾®ä¿¡ UnionID (OAuth)ã€‚
- å‡çº§æ“ä½œä¸ä¿®æ”¹ `ty_uid`ï¼Œä»…æ›´æ–° `identities` è¡¨ã€‚

### 6.2 è´¦å·åˆå¹¶ (Merge)
å½“å‘ç°ä¸¤ä¸ª `ty_uid` å±äºåŒä¸€ä¸ªå¼ºé”šç‚¹æ—¶ï¼š
1. **ä¿ç•™ä¸» UID**: é€šå¸¸ä¿ç•™éªŒè¯çº§åˆ«æœ€é«˜æˆ–åˆ›å»ºæ—¶é—´æœ€æ—©çš„ã€‚
2. **åˆå¹¶è®°å½•**: å°†è¢«åˆå¹¶ UID çš„ `identities` å’Œ `links` æŒ‡å‘ä¸» UIDã€‚
3. **æ ‡è®°åºŸå¼ƒ**: å°†æ—§ UID çŠ¶æ€è®¾ä¸º `merged` å¹¶è®°å½•åœ¨ `user_alias` è¡¨ã€‚

---

## ä¸ƒã€å·¥ç¨‹çº§å­—æ®µçº¦æŸ (Field Constraints)

- **ğŸš« ä¸¥ç¦å­—æ®µ**: `user`, `user_id`, `uid` (æ— å‰ç¼€)ã€‚
- **âœ… å¿…é¡»å­—æ®µ**: 
    - `ty_uid`: å”¯ä¸€ä¸»é”®ã€‚
    - `actor_type`: èº«ä»½è§’è‰²ã€‚
    - `handle`: æ˜“è¯»ä»£å·ã€‚
    - `cw_contact_id`: Chatwoot å…·ä½“æ˜ å°„ã€‚

---

## å…«ã€è§„æ¨¡åŒ–æ²»ç† (Scaling)

- **10W+ æ”¯æ’‘**: ç¼–å·åˆ†é…å™¨ç”± Tongye ä¸­æ¢ç®¡ç†ï¼Œä¸ä¾èµ– Chatwoot æ•°æ®åº“åºåˆ—ã€‚
- **é˜²æ­¢å›ç¯**: ä»»ä½•å‘å¾€æ¸ é“çš„å›å¤éƒ½å¿…é¡»ç”± Bridge åšæŒ‡çº¹é”å®šã€‚
- **æ¨¡å¼éš”ç¦»**: 
  - `AI_MODE`: AI é©±åŠ¨ï¼ŒChatwoot ä»…ç•™ç—•ã€‚
  - `HUMAN_MODE`: å®¢æœé©±åŠ¨ï¼ŒAI æä¾›ç§æœ‰ç§ç¬ºå»ºè®®ã€‚

---
*Verified by Antigravity at 2026-02-04 (Final Governance Standard)*
